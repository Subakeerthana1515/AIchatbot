<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>TechJays AI</title>
  {% load static %}
  <link rel="stylesheet" href="{% static 'techjays/style.css' %}">
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      height: 100vh;
      background: #f5f7fa;
    }

    #sidebar {
      width: 280px;
      background: #ffffff;
      border-right: 1px solid #e5e7eb;
      display: flex;
      flex-direction: column;
      box-shadow: 1px 0 5px rgba(0,0,0,0.05);
    }

    .sidebar-header {
      padding: 16px;
      border-bottom: 1px solid #e5e7eb;
    }

    .new-chat-btn {
      width: 100%;
      padding: 10px;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
    }

    .new-chat-btn:hover {
      background: #2563eb;
    }

    #chat-history-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }

    #chat-history-list li {
      padding: 10px 12px;
      margin: 4px 0;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
    }

    #chat-history-list li:hover {
      background: #f3f4f6;
    }

    #chat-history-list li.active {
      background: #e5e7eb;
      font-weight: 500;
    }

    .delete-btn {
      color: #9ca3af;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 16px;
    }

    .delete-btn:hover {
      color: #ef4444;
    }

    .app-container {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .header {
      padding: 16px 24px;
      background: white;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .logo {
      font-weight: 700;
      color: #3b82f6;
      font-size: 20px;
    }

    .chat-container {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      background: #f9fafb;
    }

    .message {
      margin-bottom: 16px;
      max-width: 80%;
    }

    .user-message {
      margin-left: auto;
    }

    .bot-message {
      margin-right: auto;
    }

    .message-content {
      padding: 12px 16px;
      border-radius: 12px;
      line-height: 1.5;
      font-size: 15px;
    }

    .user-content {
      background: #3b82f6;
      color: white;
      border-bottom-right-radius: 4px;
    }

    .bot-content {
      background: white;
      border: 1px solid #e5e7eb;
      border-bottom-left-radius: 4px;
    }

    .input-area {
      padding: 16px;
      background: white;
      border-top: 1px solid #e5e7eb;
    }

    .input-container {
      display: flex;
      gap: 12px;
      max-width: 900px;
      margin: 0 auto;
    }

    #user-input {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      resize: none;
      font-family: inherit;
    }

    #send-button {
      padding: 12px 20px;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    #send-button:hover {
      background: #2563eb;
    }

    .logout-btn {
      background: none;
      border: none;
      color: #6b7280;
      cursor: pointer;
      font-weight: 500;
    }

    .upload-section {
      padding: 20px;
      border-bottom: 1px solid #e5e7eb;
      background: #fff;
    }
  </style>
</head>
<body>
  <div id="sidebar">
    <div class="sidebar-header">
      <button class="new-chat-btn" onclick="startNewChat()">+ New Chat</button>
    </div>
    <ul id="chat-history-list"></ul>
  </div>

  <div class="app-container">
    <div class="header">
      <div class="logo">TechJays AI</div>
      <button class="logout-btn" onclick="logoutChat()">Logout</button>
    </div>

    <div class="upload-section">
      <form id="upload-form" enctype="multipart/form-data">
        <input type="file" id="upload-file-input" name="file" />
        <button type="submit">Upload Document</button>
      </form>
      <div id="uploaded-file-name" style="margin-top: 5px; font-style: italic;"></div>
      <button id="remove-document-btn" onclick="removeDocument()" style="margin-top:10px; background:#ef4444; color:#fff; border:none; padding:8px 12px; border-radius:6px; cursor:pointer;">
        Remove Document
      </button>
      <div id="upload-status"></div>
    </div>

    <div class="chat-container" id="chat-log"></div>

    <div class="input-area">
      <div class="input-container">
        <textarea id="user-input" placeholder="Type your message..." rows="1"></textarea>
        <button id="send-button" onclick="sendMessage()">Send</button>
      </div>
    </div>
  </div>
 
  <script>
    let currentSession = null;
    let sessionList = [];

    window.onload = async () => {
      await loadChatList();
      currentSession = localStorage.getItem("currentSession");

      if (currentSession) {
        loadChatMessages();
      } else {
        console.log("No active session found. Please start a new chat.");
      }
    };

    async function loadChatList() {
      const res = await fetch("/techjays/chatbot/get_sessions/");
      const data = await res.json();
      sessionList = data.sessions;

      const chatList = document.getElementById("chat-history-list");
      chatList.innerHTML = "";

      sessionList.forEach(session => {
        const li = document.createElement("li");
        li.innerText = session.name || `Chat ${session.session_id}`;
        if (session.session_id === currentSession) {
          li.classList.add("active");
        }

        const deleteBtn = document.createElement("button");
        deleteBtn.innerHTML = "&#10005;";
        deleteBtn.className = "delete-btn";
        deleteBtn.onclick = (e) => {
          e.stopPropagation();
          deleteChat(session.session_id);
        };

        li.appendChild(deleteBtn);

        li.onclick = () => {
          currentSession = session.session_id;
          localStorage.setItem("currentSession", currentSession);

          document.querySelectorAll("#chat-history-list li").forEach(el => el.classList.remove("active"));
          li.classList.add("active");

          loadChatMessages();
        };

        chatList.appendChild(li);
      });
    }

    async function deleteChat(sessionId) {
      const confirmDelete = confirm("Are you sure you want to delete this chat?");
      if (!confirmDelete) return;  // if user cancels, do nothing
    
      const res = await fetch("/techjays/chatbot/delete/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ session_id: sessionId })
      });
    
      if (res.ok) {
        if (sessionId === currentSession) {
          localStorage.removeItem("currentSession");
          currentSession = null;
          document.getElementById("chat-log").innerHTML = "";
        }
        await loadChatList();
      } else {
        alert("Failed to delete chat.");
      }
    }
    

    async function startNewChat() {
      const res = await fetch("/techjays/chatbot/new_chat/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({})
      });

      const data = await res.json();
      currentSession = data.session_id;
      localStorage.setItem("currentSession", currentSession);

      await loadChatList();
      document.getElementById("chat-log").innerHTML = "";
      loadChatMessages();
    }

    async function loadChatMessages() {
      const res = await fetch(`/techjays/chatbot/get_history/${currentSession}/`);
      const data = await res.json();
      const chatLog = document.getElementById("chat-log");
      chatLog.innerHTML = "";

      data.messages.forEach(msg => {
        addMessageToChat(msg.sender, msg.content);
      });

      chatLog.scrollTop = chatLog.scrollHeight;
    }

    async function sendMessage() {
      const input = document.getElementById("user-input");
      const message = input.value.trim();
      if (!message) return;

      addMessageToChat("user", message);
      input.value = "";

      const res = await fetch("/techjays/chatbot/chat/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ session_id: currentSession, message })
      });

      const data = await res.json();
      addMessageToChat("bot", data.response);
    }

    function addMessageToChat(sender, content) {
      const msgDiv = document.createElement("div");
      msgDiv.className = `message ${sender}-message`;

      const bubble = document.createElement("div");
      bubble.className = `message-content ${sender === "user" ? "user-content" : "bot-content"}`;
      bubble.innerText = content;

      msgDiv.appendChild(bubble);
      document.getElementById("chat-log").appendChild(msgDiv);
      document.getElementById("chat-log").scrollTop = document.getElementById("chat-log").scrollHeight;
    }

    const uploadForm = document.getElementById('upload-form');

uploadForm.addEventListener('submit', async function(e) {
  e.preventDefault();

  const fileInput = document.getElementById("upload-file-input");
  const file = fileInput.files[0];

  if (!file) {
    document.getElementById("upload-status").innerText = "Please select a file first.";
    return;
  }

  if (!currentSession) {
    document.getElementById("upload-status").innerText = "No active session selected.";
    return;
  }

  const formData = new FormData();
  formData.append("file", file);
  formData.append("session_id", currentSession);

  try {
    console.log("Uploading file:", file.name, "for session:", currentSession);
    const res = await fetch("/techjays/chatbot/upload/", {
      method: "POST",
      body: formData,
    });

    if (!res.ok) {
      // Try to parse error response if JSON
      let errorMsg = "Upload failed.";
      try {
        const errData = await res.json();
        errorMsg = errData.error || errorMsg;
      } catch {}

      document.getElementById("upload-status").innerText = errorMsg;
      console.error("Upload failed with status:", res.status);
      return;
    }

    const data = await res.json();

    if (data.success) {
      document.getElementById("upload-status").innerText = "Upload successful.";
      document.getElementById("uploaded-file-name").innerText = file.name;
    } else {
      document.getElementById("upload-status").innerText = data.error || "Upload failed.";
    }
  } catch (err) {
    document.getElementById("upload-status").innerText = "Upload error.";
    console.error("Fetch error:", err);
  }
});

    async function removeDocument() {
      const res = await fetch("/techjays/chatbot/remove_document/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ session_id: currentSession })
      });

      if (res.ok) {
        document.getElementById("uploaded-file-name").innerText = "";
        document.getElementById("upload-file-input").value = "";
        document.getElementById("upload-status").innerText = "Document removed.";
      } else {
        document.getElementById("upload-status").innerText = "Failed to remove document.";
      }
    }

    function logoutChat() {
      localStorage.removeItem("currentSession");
      window.location.href = "/techjays/logout_view/";
    }
    document.querySelectorAll('.logout-btn').forEach(button => {
      button.addEventListener('click', function(event) {
        if (!confirm('Are you sure you want to logout?')) {
          event.preventDefault();  // Cancel logout if user clicks "Cancel"
        }
      });
    });

  </script>
</body>
</html>